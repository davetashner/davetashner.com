---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ScrollReveal from '../../components/ScrollReveal.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

// Get all posts for prev/next navigation
const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const currentIndex = allPosts.findIndex((p) => p.id === post.id);
const prevPost =
  currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;

// Calculate reading time (average 200 words per minute)
const wordsPerMinute = 200;
const wordCount = post.body?.split(/\s+/).length || 0;
const readingTime = Math.max(1, Math.ceil(wordCount / wordsPerMinute));

const formattedPubDate = post.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const formattedUpdatedDate = post.data.updatedDate?.toLocaleDateString(
  'en-US',
  {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }
);
---

<BaseLayout
  title={`${post.data.title} - Dave Tashner`}
  description={post.data.description}
  ogType="article"
  ogImage={post.data.heroImage || '/og-image.png'}
  publishedTime={post.data.pubDate}
  modifiedTime={post.data.updatedDate}
>
  <Header slot="header" />

  <article class="section">
    <div class="container">
      <div class="article-container">
        <ScrollReveal animation="fade-up">
          <header class="article-header">
            <a href="/blog" class="back-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M19 12H5"></path>
                <path d="M12 19l-7-7 7-7"></path>
              </svg>
              Back to Blog
            </a>

            <div class="article-meta">
              <time
                datetime={post.data.pubDate.toISOString()}
                class="article-date"
              >
                {formattedPubDate}
              </time>
              <span class="meta-separator">|</span>
              <span class="reading-time">{readingTime} min read</span>
            </div>

            <h1 class="article-title">{post.data.title}</h1>

            <p class="article-description">{post.data.description}</p>

            {
              post.data.updatedDate && (
                <p class="article-updated">Updated on {formattedUpdatedDate}</p>
              )
            }

            {
              post.data.tags && post.data.tags.length > 0 && (
                <div class="article-tags">
                  {post.data.tags.map((tag) => (
                    <a href={`/blog/tag/${tag}`} class="article-tag">
                      {tag
                        .split('-')
                        .map(
                          (word) => word.charAt(0).toUpperCase() + word.slice(1)
                        )
                        .join(' ')}
                    </a>
                  ))}
                </div>
              )
            }
          </header>
        </ScrollReveal>

        {
          post.data.heroImage && (
            <ScrollReveal animation="fade-up" delay={100}>
              <div class="hero-image-container">
                <img
                  src={post.data.heroImage}
                  alt={`Cover image for ${post.data.title}`}
                  class="hero-image"
                />
              </div>
            </ScrollReveal>
          )
        }

        <ScrollReveal animation="fade-up" delay={150}>
          <div class="prose">
            <Content />
          </div>
        </ScrollReveal>

        {
          (prevPost || nextPost) && (
            <ScrollReveal animation="fade-up" delay={200}>
              <nav class="post-navigation">
                {prevPost ? (
                  <a
                    href={`/blog/${prevPost.id}`}
                    class="nav-post nav-post-prev"
                  >
                    <span class="nav-post-label">Previous</span>
                    <span class="nav-post-title">{prevPost.data.title}</span>
                  </a>
                ) : (
                  <div />
                )}
                {nextPost ? (
                  <a
                    href={`/blog/${nextPost.id}`}
                    class="nav-post nav-post-next"
                  >
                    <span class="nav-post-label">Next</span>
                    <span class="nav-post-title">{nextPost.data.title}</span>
                  </a>
                ) : (
                  <div />
                )}
              </nav>
            </ScrollReveal>
          )
        }
      </div>
    </div>
  </article>

  <Footer slot="footer" />
</BaseLayout>

<style>
  .nav-link {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .nav-link:hover {
    color: var(--color-accent);
  }

  .article-container {
    max-width: 48rem;
    margin: 0 auto;
  }

  .article-header {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    margin-bottom: 2rem;
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
  }

  .meta-separator {
    opacity: 0.5;
  }

  .article-date,
  .reading-time {
    color: var(--color-text-muted);
  }

  .article-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin: 0 0 1rem 0;
    line-height: 1.3;
  }

  @media (min-width: 768px) {
    .article-title {
      font-size: 2.5rem;
    }
  }

  .article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.6;
  }

  .article-updated {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-style: italic;
    margin: 1rem 0 0 0;
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .article-tag {
    font-size: 0.75rem;
    color: var(--color-accent);
    background-color: var(--color-accent-light);
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-weight: 500;
    text-decoration: none;
    transition:
      background-color var(--transition-fast),
      color var(--transition-fast),
      transform var(--transition-fast);
  }

  .article-tag:hover {
    background-color: var(--color-accent);
    color: white;
    transform: translateY(-1px);
  }

  .hero-image-container {
    margin-bottom: 2.5rem;
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .hero-image {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Prose styles for markdown content */
  .prose {
    font-size: 1.0625rem;
    line-height: 1.75;
    color: var(--color-text-secondary);
  }

  .prose :global(h2) {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 2.5rem 0 1rem 0;
  }

  .prose :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 2rem 0 0.75rem 0;
  }

  .prose :global(h4) {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 1.5rem 0 0.5rem 0;
  }

  .prose :global(p) {
    margin: 0 0 1.5rem 0;
  }

  .prose :global(a) {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .prose :global(a:hover) {
    color: var(--color-accent-hover);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin: 0 0 1.5rem 0;
    padding-left: 1.5rem;
  }

  .prose :global(li) {
    margin-bottom: 0.5rem;
  }

  .prose :global(blockquote) {
    border-left: 3px solid var(--color-accent);
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: var(--color-text-tertiary);
  }

  .prose :global(code) {
    background-color: var(--color-bg-tertiary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: var(--font-mono);
  }

  .prose :global(pre) {
    background-color: var(--color-bg-tertiary);
    padding: 1.25rem;
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .prose :global(pre code) {
    background-color: transparent;
    padding: 0;
    font-size: 0.875rem;
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    margin: 1.5rem 0;
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2.5rem 0;
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }

  .prose :global(th),
  .prose :global(td) {
    border: 1px solid var(--color-border);
    padding: 0.75rem;
    text-align: left;
  }

  .prose :global(th) {
    background-color: var(--color-bg-secondary);
    font-weight: 600;
    color: var(--color-text-primary);
  }

  /* Post navigation */
  .post-navigation {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .nav-post {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem;
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition:
      border-color var(--transition-fast),
      transform var(--transition-fast);
  }

  .nav-post:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
  }

  .nav-post-next {
    text-align: right;
  }

  .nav-post-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .nav-post-title {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--color-text-primary);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .nav-post:hover .nav-post-title {
    color: var(--color-accent);
  }

  @media (max-width: 640px) {
    .post-navigation {
      grid-template-columns: 1fr;
    }

    .nav-post-next {
      text-align: left;
    }
  }
</style>
